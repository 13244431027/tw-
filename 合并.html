<!doctype html>

<html lang="zh-CN"> <head> <meta charset="utf-8"/> <meta name="viewport" content="width=device-width,initial-scale=1"/> <title>多扩展合并器｜B站10000why制作</title> <style> /* ================================ XP Retro — Header auto-hide, fixed menu 主题自适应：卡片/标题/控件/代码框全部跟随主题 ================================ */
:root{
–bg:#f2f6fb;
–bg-noise: radial-gradient(ellipse at 30% 20%, rgba(255,255,255,.65), rgba(255,255,255,0) 45%),
radial-gradient(ellipse at 70% 80%, rgba(255,255,255,.45), rgba(255,255,255,0) 40%);
–fg:#0b0f1a;
–muted:#4b5563;
–line:#c3cfe0;
–line-soft:#e6eef9;
–panel:#eaf2fb;
–panel-weak:#f7fbff;
–win-border:#7f9db9;

–accent:#3a6ea5;
–accent-hi:#5d8cc0;
–accent-mid:#3970a8;
–accent-lo:#2f5d8f;
/* 用于半透明描边/外圈的 RGB 数值 */
–accent-rgb:58,110,165;

–accent-fg:#134b83;

–btn-top:#ffffff;
–btn-bot:#e9eff7;
–focus:#002a6e;

–mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,“Courier New”,monospace;
–xp-font:Tahoma,Verdana,Segoe UI,Arial,sans-serif;

/* 滚动条/滑块（蓝） */
–sb-border:#2b4e7a;
–sb-ring:#96b3d6;
–sb-track1:#eef5ff;
–sb-track2:#f7fbff;
–sb-thumb1:#e6f0ff;
–sb-thumb2:#c9daf5;
–sb-arrow:#24486f;

/* —— 新增：扩展布（卡片）在不同主题下自适应的变量 —— */
–card-border: var(–win-border);
–card-body1:#ffffff;
–card-body2:#f8fbff;
–card-head1:#f2f8ff;
–card-head2:#e1efff;

/* 光泽与阴影 */
–gloss-1: linear-gradient(180deg, rgba(255,255,255,.72), rgba(255,255,255,0) 48%);
–shadow-sm: 0 1px 0 rgba(0,0,0,.06);
–shadow-md: 0 2px 12px rgba(0,0,0,.10);
–shadow-lg: 0 10px 28px rgba(0,0,0,.22);

/* 尺寸变量（JS 会动态更新 --header-offset） /
–header-h: 48px; / 实际标题栏高度 /
–menu-h: 36px; / 菜单栏固定高度 /
–header-offset: 48px; / 头部可见时 = --header-h；隐藏时 = 0 */
}

/* —— 主题：Olive —— */
body.theme-olive{
–accent:#6f8a24;–accent-hi:#90a23a;–accent-mid:#6f8a24;–accent-lo:#536b18;
–accent-rgb:111,138,36;
–accent-fg:#28420a;
–win-border:#879b56;–panel:#eef5e0;–panel-weak:#f7fbf0;

–sb-border:#576d1b;–sb-ring:#aabf6a;–sb-track1:#f3f8e8;–sb-track2:#fbfff5;
–sb-thumb1:#eef6d7;–sb-thumb2:#d5e4ab;–sb-arrow:#3a4f12;

/* 卡片与标题色系（偏绿、柔和） */
–card-border:#8da359;
–card-body1:#ffffff;
–card-body2:#f7fbf0;
–card-head1:#f7fbe9;
–card-head2:#eaf3d7;
}

/* —— 主题：Silver —— */
body.theme-silver{
–accent:#7a7a7a;–accent-hi:#9ea8b4;–accent-mid:#7a7a7a;–accent-lo:#5f6a75;
–accent-rgb:122,122,122;
–accent-fg:#2e3540;
–win-border:#a5b0bc;–panel:#eef2f7;–panel-weak:#f8fafc;

–sb-border:#5f6a75;–sb-ring:#b7c2cf;–sb-track1:#f0f3f6;–sb-track2:#fafbfd;
–sb-thumb1:#e6ecf3;–sb-thumb2:#cfd9e5;–sb-arrow:#2f3e52;

/* 卡片与标题色系（银灰） */
–card-border:#a5b0bc;
–card-body1:#ffffff;
–card-body2:#f8fafc;
–card-head1:#f3f5f8;
–card-head2:#e6ebf2;
}

/* 基础排版与背景纹理 */
*{box-sizing:border-box}
html,body{height:100%}
body{
margin:0;color:var(–fg);font-family:var(–xp-font);line-height:1.42;
background:linear-gradient(180deg,#e9f2ff 0%, #f2f7ff 40%, #f7fbff 100%), var(–bg-noise), var(–bg);
background-attachment: fixed;
}

/* 顶部标题栏（可滑出/滑入） */
header{
position:fixed; left:0; right:0; top:0; z-index:6;
display:flex;align-items:center;gap:10px;padding:6px 10px 10px;
height:var(–header-h);
background:linear-gradient(var(–accent-hi),var(–accent-mid) 58%,var(–accent-lo));
color:#fff;border-bottom:1px solid #274b76;
box-shadow:0 2px 0 rgba(0,0,0,.08),0 10px 26px rgba(0,0,0,.18);
transform:translateY(0); transition:transform .22s ease;
}
header.hidden{ transform:translateY(calc(-1 * var(–header-h))); }
header::after{
content:“”;position:absolute;left:0;right:0;top:0;height:36px;pointer-events:none;background:var(–gloss-1);
}
header h1{margin:0;font-size:17px;font-weight:700;letter-spacing:.2px;text-shadow:0 1px 0 rgba(0,0,0,.15)}
header .sub{font-size:12px;color:#e7f0fa;opacity:.95}
header svg rect,header svg path{stroke:#eef6ff}

.toolbar{display:flex;gap:8px;align-items:center;margin-left:auto}
.theme-dots{display:flex;gap:6px;align-items:center}
.dot{width:14px;height:14px;border-radius:50%;
border:1px solid rgba(0,0,0,.28);
box-shadow:inset 0 0 0 1px rgba(255,255,255,.75), 0 1px 0 rgba(255,255,255,.35);
cursor:pointer; transition:transform .06s ease, filter .12s ease}
.dot.blue{background:linear-gradient(#5b8ec9,#2f5d8f)}
.dot.olive{background:linear-gradient(#a1b663,#536b18)}
.dot.silver{background:linear-gradient(#cdd6df,#5f6a75)}
.dot:hover{filter:brightness(1.06)}
.dot:active{transform:translateY(1px)}

.xp-winbtns{display:flex;gap:6px;margin-left:6px}
.xp-wbtn{
width:22px;height:18px;border:1px solid var(–sb-border);
background:linear-gradient(#eef5ff,#cfdff5);
color:#123;border-radius:3px;display:flex;align-items:center;justify-content:center;line-height:1;
user-select:none;cursor:pointer;
box-shadow:inset 1px 1px 0 #fff,inset -1px -1px 0 var(–sb-ring), var(–shadow-sm);
transition: transform .06s ease;
}
.xp-wbtn:active{transform:translateY(1px);background:linear-gradient(#d6e6ff,#f1f6ff)}

/* 顶部菜单条 */
nav.menu{
position:fixed; left:0; right:0; top:var(–header-offset); z-index:5;
display:flex;gap:2px;align-items:center;padding:3px 6px;
height:var(–menu-h);
background:linear-gradient(#f5f7fc,#ecf2fb);
border-bottom:1px solid #c7d7ea;box-shadow:inset 0 1px 0 #fff, 0 2px 8px rgba(0,0,0,.06);
}
.menu .item{
padding:4px 10px;font-size:12px;color:var(–accent-fg);border:1px solid transparent;border-radius:3px;
user-select:none;cursor:default;position:relative;text-shadow:0 1px 0 #fff;
}
.menu .item:hover{
background:linear-gradient(#fff,#e9eff7);
border-color:var(–accent);
box-shadow:inset 1px 1px 0 #fff,inset -1px -1px 0 #d8e4f3,var(–shadow-sm);
}

/* 弹出菜单 */
.xp-menu{
position:absolute;background:#fff;border:1px solid #9fb6d3;border-radius:6px;
box-shadow:0 2px 0 #e9eef5,var(–shadow-lg),inset 0 0 0 1px #fff;
padding:6px;z-index:6;min-width:160px;animation:xpPop .14s ease-out; backdrop-filter:saturate(1.05);
}
.xp-menu .mitem{
padding:6px 12px;font-size:12px;border:1px solid transparent;border-radius:4px;
color:#194d82;cursor:default;user-select:none;display:flex;align-items:center;gap:8px;
}
.xp-menu .mitem:hover{
background:linear-gradient(#fff,#edf4ff);border-color:#88a8cf;
box-shadow:inset 1px 1px 0 #fff,inset -1px -1px 0 #cfe0ff;
}
.hidden{display:none!important}

/* 主体布局 */
main{
max-width:1180px;
margin: calc(var(–header-offset) + var(–menu-h) + 10px) auto 60px;
padding:0 14px;
transition: margin-top .22s ease;
}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
@media (max-width:1024px){.grid{grid-template-columns:1fr}}

/* ===== 扩展布（卡片）主题自适应 ===== */
.card{
background:linear-gradient(180deg,var(–card-body1),var(–card-body2));
border:1px solid var(–card-border);border-radius:10px;
box-shadow:inset 0 0 0 1px #fff, 0 1px 0 #e9eef5, var(–shadow-md);
animation:xpPop .22s cubic-bezier(.3,1.2,.3,1);transform-origin:50% 0; overflow:hidden;
}
.card h2{
margin:0;padding:8px 12px;background:linear-gradient(180deg, var(–card-head1), var(–card-head2));
color:var(–accent-fg);font-size:13px;border-bottom:1px solid var(–card-border);position:relative;
}
.card h2::after{content:“”;position:absolute;left:0;right:0;top:0;height:50%;background:linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,255,255,0))}
.card .body{padding:12px 14px}

/* 卡片 focus-within 的主题高亮外圈（不刺眼） */
.ext-card:focus-within{
box-shadow:
inset 0 0 0 1px #fff,
0 0 0 1px var(–card-border),
0 0 0 3px rgba(var(–accent-rgb), .18),
0 6px 18px rgba(0,0,0,.08);
transition: box-shadow .15s ease;
}

label{font-size:12px;color:#4b5563;text-shadow:0 1px 0 #fff}

/* 输入/选择/文本域的主题聚焦效果（统一） */
input[type=“text”],.input,textarea,select.input{
width:100%;background:#fff;color:#000;border:1px solid var(–card-border);border-radius:6px;padding:8px 10px;
font-size:13px;font-family:var(–mono);
box-shadow:inset 1px 1px 0 #fff,inset -1px -1px 0 #c8d9ee;
transition:border-color .12s ease, box-shadow .12s ease, background .12s ease;
}
input[type=“text”]:focus,.input:focus,textarea:focus,select.input:focus{
outline:2px solid rgba(var(–accent-rgb),.16);outline-offset:2px;border-color:var(–accent);
box-shadow:inset 1px 1px 0 #fff, 0 0 0 2px rgba(var(–accent-rgb),.22);
background:linear-gradient(#fff,#f7fbff);
}
textarea{min-height:260px;resize:vertical;line-height:1.48}

.row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:8px}
.row .full{ grid-column: 1 / -1; }
@media (max-width:760px){.row{grid-template-columns:1fr}}

/* URL 输入 + 获取：分离布局；聚焦动画 */
.url-inline{
–ctl-h: 38px;
–url-w: 760px;
–url-w-focus: 620px;
–btn-slot: 120px;
display:flex;align-items:center;justify-content:center;gap:12px;width:100%;flex-wrap:nowrap;margin:0 auto;
}
.url-inline .url-input{
height:var(–ctl-h);
width: clamp(280px, min(var(–url-w), 100%), var(–url-w));
transition: width .24s ease;
}
.url-inline:focus-within .url-input{ width: clamp(280px, calc(100% - var(–btn-slot)), var(–url-w-focus)); }
.url-inline .url-btn{
height:var(–ctl-h);display:none;padding:0 14px;line-height:calc(var(–ctl-h) - 2px);border-radius:6px;
}
.url-inline:focus-within .url-btn{ display:inline-flex; align-items:center; }

button{
appearance:none;font-family:var(–xp-font);font-size:13px;padding:7px 13px;
border-radius:8px;color:#0b0f1a;border:1px solid var(–card-border);
background:linear-gradient(var(–btn-top),var(–btn-bot));
box-shadow:inset 1px 1px 0 #fff,inset -1px -1px 0 #c8d9ee, var(–shadow-sm);
cursor:pointer; transition:transform .06s ease, filter .12s ease, box-shadow .12s ease;
}
button:hover{filter:brightness(1.02)}
button:active{transform:translateY(1px);background:linear-gradient(#e7effa,#f6f9ff);box-shadow:inset -1px -1px 0 #fff,inset 1px 1px 0 #c8d9ee}
button:focus-visible{outline:2px solid rgba(var(–accent-rgb), .2);outline-offset:2px;border-color:var(–accent)}
button:disabled{opacity:.65;cursor:not-allowed;filter:grayscale(.2)}
.btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
.primary{border-color:#6aa2de;background:linear-gradient(#f3f9ff,#dcecff)}
.ok{border-color:#4c8d44;background:linear-gradient(#f7fff7,#dff0df);color:#0b3d0b}
.ghost{border-color:#bfcddf;background:linear-gradient(#fff,#f4f6fa)}

/* —— 拖放框：主题自适应 —— */
.drop{
border:1px dashed var(–card-border);border-radius:10px;padding:12px;text-align:center;
color:#5a6677;font-size:12px;background:linear-gradient(var(–card-body1),var(–card-body2));
box-shadow:inset 0 1px 0 #fff; transition:border-color .15s ease, box-shadow .15s ease, background .2s ease;
}
.drop.drag{
background:linear-gradient(#fff,#f5faff);
border-color:var(–accent);
box-shadow:inset 0 1px 0 #fff, 0 0 0 3px rgba(var(–accent-rgb), .14);
}

/* 只读输出 */
.output{min-height:200px;border-radius:10px}
.pill{
display:inline-flex;align-items:center;gap:8px;padding:5px 12px;border-radius:999px;font-size:12px;
border:1px solid #c3d7ec;background:linear-gradient(#f9fbff,#f3f7fd);color:#24486f; box-shadow:inset 0 1px 0 #fff
}
.small{font-size:12px;color:#4b5563}
.hr{height:1px;background:linear-gradient(90deg,transparent,#cbd9ee,transparent);margin:12px 0}

/* 弹窗（信息/提示） */
#xpModalMask{position:fixed;inset:0;background:rgba(0,0,0,.18);z-index:20}
#xpModal{
position:fixed;left:50%;top:24%;transform:translateX(-50%);width:460px;max-width:92vw;z-index:21;
border:1px solid var(–card-border);border-radius:12px;background:#fff;
box-shadow:var(–shadow-lg),inset 0 0 0 1px #fff; overflow:hidden;
}
#xpModal .titlebar{
background:linear-gradient(var(–accent-hi),var(–accent-mid) 60%,var(–accent-lo));
color:#fff;padding:8px 10px;display:flex;align-items:center;justify-content:space-between;
border-bottom:1px solid #274b76;font-weight:700;font-size:13px;position:relative;
}
#xpModal .titlebar::after{content:“”;position:absolute;left:0;right:0;top:0;height:50%;background:var(–gloss-1)}
#xpModal .titlebar .btn{
width:20px;height:20px;display:flex;align-items:center;justify-content:center;border-radius:3px;
border:1px solid var(–sb-border);background:linear-gradient(#eef5ff,#cfdff5);color:#123;cursor:pointer;
box-shadow:inset 1px 1px 0 #fff,inset -1px -1px 0 var(–sb-ring), var(–shadow-sm); padding:0;
}
#xpModal .body{display:flex;gap:12px;padding:14px 12px}
#xpModal .body .icon{
width:34px;height:34px;border-radius:8px;border:1px solid var(–card-border);
background:linear-gradient(#f2f8ff,#dfeeff);display:flex;align-items:center;justify-content:center;font-weight:700;color:#24486f
}
#xpModal .msg{font-size:13px;color:#0b0f1a;line-height:1.5;white-space:pre-wrap}
#xpModal .actions{display:flex;justify-content:flex-end;gap:10px;padding:10px 12px 14px}

/* 关闭屏 */
#closedScreen{position:fixed;inset:0;display:none;z-index:7;background:linear-gradient(#eef5ff,#f7fbff);
align-items:center;justify-content:center;flex-direction:column;gap:12px;color:#003366}
#closedScreen .panel{
background:#fff;border:1px solid var(–card-border);border-radius:12px;padding:18px 20px;
box-shadow:var(–shadow-lg), inset 0 0 0 1px #fff;animation:xpPop .22s ease-out
}
body.is-closed header,body.is-closed nav.menu,body.is-closed main{display:none}
body.is-closed #closedScreen{display:flex}

/* SVG 预览弹窗 */
#svgModalMask{position:fixed;inset:0;background:rgba(0,0,0,.28);z-index:40;display:none}
#svgModal{
position:fixed;left:50%;top:8%;transform:translateX(-50%);width:min(1100px,94vw);max-height:84vh;z-index:41;
border:1px solid var(–card-border);border-radius:12px;background:#fff;
box-shadow:var(–shadow-lg),inset 0 0 0 1px #fff;display:none;overflow:hidden
}
#svgModal .titlebar{
background:linear-gradient(var(–accent-hi),var(–accent-mid) 60%,var(–accent-lo));color:#fff;
padding:8px 10px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #274b76;
font-weight:700;font-size:13px; position:relative;
}
#svgModal .titlebar::after{content:“”;position:absolute;left:0;right:0;top:0;height:50%;background:var(–gloss-1)}
#svgModal .close{width:22px;height:20px;display:flex;align-items:center;justify-content:center;border:1px solid var(–sb-border);
background:linear-gradient(#eef5ff,#cfdff5);border-radius:3px;color:#123;cursor:pointer;box-shadow:inset 1px 1px 0 #fff,inset -1px -1px 0 #cfdfff}
#svgModal .body{padding:12px 12px 6px;overflow:auto;max-height:calc(84vh - 48px);background:var(–panel-weak)}
#svgModal .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
.blockCard{border:1px solid var(–card-border);border-radius:12px;background:#fff;box-shadow:inset 0 0 0 1px #fff,0 1px 0 #e9eef5}
.blockCard .hd{font-size:12px;color:#334155;padding:8px;border-bottom:1px dashed #d7e3f3;display:flex;gap:8px;align-items:center}
.blockCard .cnt{padding:12px;display:flex;justify-content:center;align-items:center}
.blockCard .tag{font-size:11px;padding:2px 6px;border-radius:999px;background:#f1f5ff;border:1px solid #cfe0ff;color:#245;}
.blockCard svg{max-width:100%;height:auto}

/* —— 新增：编辑→重命名 对话框 —— */
#renameMask{position:fixed;inset:0;background:rgba(0,0,0,.18);z-index:30}
#renameModal{
position:fixed;left:50%;top:22%;transform:translateX(-50%);width:460px;max-width:92vw;z-index:31;
border:1px solid var(–card-border);border-radius:12px;background:#fff;
box-shadow:var(–shadow-lg),inset 0 0 0 1px #fff; overflow:hidden;
}
#renameModal .titlebar{
background:linear-gradient(var(–accent-hi),var(–accent-mid) 60%,var(–accent-lo));
color:#fff;padding:8px 10px;display:flex;align-items:center;justify-content:space-between;
border-bottom:1px solid #274b76;font-weight:700;font-size:13px;position:relative;
}
#renameModal .titlebar::after{content:“”;position:absolute;left:0;right:0;top:0;height:50%;background:var(–gloss-1)}
#renameModal .titlebar .btn{
width:20px;height:20px;display:flex;align-items:center;justify-content:center;border-radius:3px;
border:1px solid var(–sb-border);background:linear-gradient(#eef5ff,#cfdff5);color:#123;cursor:pointer;
box-shadow:inset 1px 1px 0 #fff,inset -1px -1px 0 var(–sb-ring), var(–shadow-sm); padding:0;
}
#renameModal .body{display:flex;flex-direction:column;gap:10px;padding:14px 12px}
#renameModal .actions{display:flex;justify-content:flex-end;gap:10px;padding:10px 12px 14px}
#renameMask.hidden,#renameModal.hidden{display:none}

/* —— 新增：移除卡片的“关闭”特效 —— */
@keyframes xpClose{
0%{opacity:1;transform:translateY(0) scale(1)}
100%{opacity:0;transform:translateY(8px) scale(.92)}
}
.ext-card.closing{animation:xpClose .18s ease-in forwards}

/* 全局滚动条隐藏（保留页面滚动） */
html, body { overflow: auto; }
body { -ms-overflow-style:none; scrollbar-width:none; }
body::-webkit-scrollbar{width:0;height:0;display:none}

/* 文本域滚动条 & 滑块（XP） */
textarea{overflow:auto; scrollbar-width:thin; scrollbar-color:var(–sb-thumb2) var(–sb-track1);}
textarea::-webkit-scrollbar{ width:16px; height:16px }
textarea::-webkit-scrollbar-track{
background:linear-gradient(var(–sb-track1),var(–sb-track2));
border:1px solid var(–sb-ring); border-radius:8px; box-shadow:inset 0 1px 0 #fff;
}
textarea::-webkit-scrollbar-thumb{
border-radius:8px;border:1px solid var(–sb-border);
background:linear-gradient(var(–sb-thumb1),var(–sb-thumb2));
box-shadow:inset 1px 1px 0 #fff,inset -1px -1px 0 var(–sb-ring),0 0 0 1px var(–sb-ring);
}
textarea:hover::-webkit-scrollbar-thumb{filter:brightness(1.02)}
textarea:active::-webkit-scrollbar-thumb{transform:translateY(1px)}
textarea::-webkit-scrollbar-corner{
background:linear-gradient(var(–sb-track1),var(–sb-track2));
border:1px solid var(–sb-ring);border-radius:4px;box-shadow:inset 0 1px 0 #fff;
}
textarea::-webkit-scrollbar-button{
width:16px;height:16px;background:linear-gradient(#eef5ff,#cfdff5);
border:1px solid var(–sb-border);border-radius:3px;
box-shadow:inset 1px 1px 0 #fff,inset -1px -1px 0 var(–sb-ring);
}

/* —— 代码框点击动画（无 canvas）：墨水波纹 —— /
.code-wrap{ position:relative; }
.code-wrap .ink{
position:absolute; border-radius:50%; pointer-events:none; transform:scale(0);
opacity:.22; will-change: transform, opacity; mix-blend-mode: multiply;
}
@keyframes codeInk {
0% { transform:scale(0); opacity:.28; }
60% { transform:scale(1); opacity:.20; }
100% { transform:scale(2.6); opacity:0; }
}
/ 按压（鼠标按下）的小幅内凹阴影 */
textarea.code:active{
box-shadow:inset 0 2px 6px rgba(0,0,0,.06), 0 0 0 2px rgba(var(–accent-rgb), .18);
}

/* 微动效 */
@keyframes xpPop{
0%{opacity:0;transform:translateY(6px) scale(.96)}
60%{opacity:1;transform:translateY(0) scale(1.02)}
100%{opacity:1;transform:translateY(0) scale(1)}
}
</style>

</head> <body> <header id="topHeader"> <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"> <rect x="3" y="4" width="18" height="16" rx="2" stroke-width="1.2"/><path d="M7 9h10M7 13h6" stroke-width="1.1" stroke-linecap="round"/> </svg> <div>
多扩展合并器｜B站10000why制作
<div class="sub">把多个 JS 扩展合并为一个文件（含多套扩展）。</div> </div> <div style="flex:1"></div> <div class="toolbar"> <div class="theme-dots" title="切换 XP 主题"> <div class="dot blue" data-theme="blue" aria-label="Luna Blue"></div> <div class="dot olive" data-theme="olive" aria-label="Olive"></div> <div class="dot silver" data-theme="silver" aria-label="Silver"></div> </div> <div class="xp-winbtns" title="窗口控制"> <div class="xp-wbtn" id="btnMax"><span>□</span></div> <div class="xp-wbtn" id="btnClose"><span>×</span></div> </div> </div> </header> <nav class="menu" aria-label="应用菜单"> <div class="item" id="menuNew">新建</div> <div class="item" id="menuEdit">编辑</div> <div class="item" id="menuView">视图</div> <div class="item">工具</div> <div class="item">帮助</div> </nav> <main> <div class="grid" id="extGrid"> <!-- 扩展卡 1 --> <section class="card ext-card" data-key="A" data-fixed="true">
扩展 1
<div class="body"> <div class="row"> <div> <label>从文件载入（.js）</label> <div class="drop">拖拽到此 / 点击选择 <input type="file" accept=".js" style="display:none"/></div> </div> <div> <label>覆盖 ID（可选）</label> <input class="input id-input" placeholder="例如: myExtA"/> </div> </div>
    <div class="row" style="margin-top:8px">
      <div>
        <label>覆盖 Name（可选）</label>
        <input class="input name-input" placeholder="例如: 扩展 A"/>
      </div>
      <div class="btns" style="align-items:end;justify-content:flex-end">
        <button class="ghost fill-demo" data-demo="A">填充示例 A</button>
      </div>
    </div>

    <!-- URL 行：位于 Name 下面 -->
    <div class="row" style="margin-top:8px">
      <div class="full">
        <label>从 URL 载入（支持 https:// 与 data:）</label>
        <div class="url-inline">
          <input class="input url-input" placeholder="例如: https://raw.githubusercontent.com/user/repo/main/extA.js"/>
          <button class="ghost url-btn" disabled>获取</button>
        </div>
      </div>
    </div>

    <div style="margin-top:8px">
      <label>源码</label>
      <textarea class="code" spellcheck="false" placeholder="将扩展 A 的 JS 源码粘贴到这里，或使用上方文件/URL 载入"></textarea>
    </div>
  </div>
</section>

<!-- 扩展卡 2 -->
<section class="card ext-card" data-key="B" data-fixed="true">
  <h2>扩展 2</h2>
  <div class="body">
    <div class="row">
      <div>
        <label>从文件载入（.js）</label>
        <div class="drop">拖拽到此 / 点击选择 <input type="file" accept=".js" style="display:none"/></div>
      </div>
      <div>
        <label>覆盖 ID（可选）</label>
        <input class="input id-input" placeholder="例如: myExtB"/>
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <div>
        <label>覆盖 Name（可选）</label>
        <input class="input name-input" placeholder="例如: 扩展 B"/>
      </div>
      <div class="btns" style="align-items:end;justify-content:flex-end">
        <button class="ghost fill-demo" data-demo="B">填充示例 B</button>
      </div>
    </div>

    <!-- URL 行 -->
    <div class="row" style="margin-top:8px">
      <div class="full">
        <label>从 URL 载入（支持 https:// 与 data:）</label>
        <div class="url-inline">
          <input class="input url-input" placeholder="例如: https://gitee.com/user/repo/raw/master/extB.js"/>
          <button class="ghost url-btn" disabled>获取</button>
        </div>
      </div>
    </div>

    <div style="margin-top:8px">
      <label>源码</label>
      <textarea class="code" spellcheck="false" placeholder="将扩展 B 的 JS 源码粘贴到这里，或使用上方文件/URL 载入"></textarea>
    </div>
  </div>
</section>
</div> <!-- 合并 与 导出 --> <section class="card hidden" id="mergeCard" style="margin-top:12px">
合并 与 导出
<div class="body"> <div class="btns"> <button class="primary" id="mergeRelease">合并</button> <button class="ok" id="downloadRelease" disabled>下载JS代码</button> <button id="makeDataURL" disabled>复制 Data URL</button> <button id="copyOutput" class="ghost">复制结果</button> <button class="ghost" id="scan">扫描冲突与建议</button> <button class="ghost" id="swap">交换前两个代码区</button> <button id="wrapToggle" class="ghost">自动换行: 关</button> <button class="ghost" id="clearAll">清空</button> <span class="pill hidden" id="statBytes">0 B</span> </div> <div class="hr"></div> <label>合并结果（只读）</label> <textarea id="output" class="output" readonly></textarea> <div class="foot small">提示：此发布版用于 TurboWarp/Scratch 外部加载。</div> </div> </section> </main> <!-- 提示弹窗 --> <div id="xpModalMask" class="hidden"></div> <div id="xpModal" class="hidden" role="dialog" aria-modal="true" aria-labelledby="xpModalTitle"> <div class="titlebar"><span id="xpModalTitle">提示</span><button class="btn" id="xpModalClose" aria-label="关闭">×</button></div> <div class="body"><div class="icon" id="xpModalIcon">i</div><div class="msg" id="xpModalMsg"></div></div> <div class="actions"><button id="xpModalOk">确定</button></div> </div> <!-- 新建/编辑/视图弹出菜单 --> <div id="menuNewPopup" class="xp-menu hidden" role="menu" aria-label="新建菜单"> <div class="mitem" id="miAddExt">新建扩展布</div> </div> <div id="menuEditPopup" class="xp-menu hidden" role="menu" aria-label="编辑菜单"> <div class="mitem" id="miRename">重命名扩展布</div> </div> <div id="menuViewPopup" class="xp-menu hidden" role="menu" aria-label="视图菜单"> <div class="mitem" id="miPreviewBlocks">预览SVG积木图像</div> </div> <!-- 关闭屏 --> <div id="closedScreen"> <div class="panel"> <div style="font-weight:700;margin-bottom:6px;">本页已关闭</div> <div style="font-size:12px;color:#4b5563;margin-bottom:10px;">（若浏览器阻止彻底关闭，这里以模拟关闭方式隐藏页面）</div> <div class="btns"><button class="primary" id="btnReopen">重新打开</button><button class="ghost" onclick="location.reload()">刷新页面</button></div> </div> </div> <!-- SVG 预览弹窗 --> <div id="svgModalMask"></div> <div id="svgModal" role="dialog" aria-modal="true" aria-labelledby="svgModalTitle"> <div class="titlebar"> <span id="svgModalTitle">积木预览（SVG）</span> <button class="close" id="svgModalClose" aria-label="关闭">×</button> </div> <div class="body"> <div id="svgContainer" class="grid"></div> </div> </div> <!-- —— 重命名对话框 —— --> <div id="renameMask" class="hidden"></div> <div id="renameModal" class="hidden" role="dialog" aria-modal="true" aria-labelledby="renameTitle"> <div class="titlebar"><span id="renameTitle">重命名扩展布</span><button class="btn" id="renameClose" aria-label="关闭">×</button></div> <div class="body"> <label style="font-size:12px;">选择扩展</label> <select id="renameSelect" class="input"></select> <label style="font-size:12px;">新名称</label> <input id="renameInput" class="input" placeholder="例如：图像处理扩展"/> </div> <div class="actions"> <button class="primary" id="renameOk">重命名</button> <button class="ghost" id="renameCancel">取消</button> </div> </div> <script> /* ===== 基础工具 ===== */ const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s)), byId=id=>document.getElementById(id); const S={mergedRelease:''}; const bytes=s=>new TextEncoder().encode(s).length, fmt=n=>n<1024?`${n} B`:n<1048576?`${(n/1024).toFixed(1)} KB`:`${(n/1048576).toFixed(2)} MB`; /* ===== 顶部 Header 自动隐藏/显示，Menu 固定 ===== */ const root = document.documentElement; const header = byId('topHeader'); const HEADER_H = 48; // 与 --header-h 同步 const SHOW_OFFSET = HEADER_H; // 可见时 nav 顶部偏移 let lastY = window.scrollY || 0; let stateHidden = false; let lock = false; function setHeaderVisible(on){ if(lock) return; stateHidden = !on; header.classList.toggle('hidden', !on); root.style.setProperty('--header-offset', on ? SHOW_OFFSET + 'px' : '0px'); } function onScroll(){ const y = window.scrollY || 0; const dy = y - lastY; lastY = y; if(dy > 6 && y > 30){ if(!stateHidden) setHeaderVisible(false); }else if(dy < -6){ if(stateHidden) setHeaderVisible(true); } } window.addEventListener('scroll', onScroll, {passive:true}); root.style.setProperty('--header-offset', SHOW_OFFSET + 'px'); /* ===== 文件/URL 读取 ===== */ const load=(f,ta)=>{ const r=new FileReader(); r.onload=()=>{ ta.value=r.result; ta.dataset.filesize=String(f.size||0); ta.dispatchEvent(new Event('input')); }; r.readAsText(f); }; async function loadFromURL(url, ta, btn){ if(!url){ await xpAlert('请输入有效的 URL。',{title:'提示',type:'warn'}); return; } const u = url.trim(); const prevText = btn ? btn.textContent : ''; if(btn){ btn.disabled = true; btn.textContent = '获取'; } try{ const res = await fetch(u); if(!res.ok) throw new Error(`HTTP ${res.status}`); const text = await res.text(); ta.value = text; ta.dataset.filesize = String(text.length); ta.dispatchEvent(new Event('input')); await xpAlert('已从 URL 载入完成。',{title:'信息',type:'info'}); }catch(err){ await xpAlert( '从该 URL 读取失败：' + String(err) + '\n\n可能原因：\n• 目标服务器未开启 CORS。\n• URL 不存在或需鉴权。\n\n建议：\n• 使用可直链 RAW 地址（GitHub/Gitee Raw）。\n• 或下载后用“从文件载入”。', {title:'错误',type:'error'} ); }finally{ if(btn){ btn.disabled=false; btn.textContent = prevText || '获取'; } } } /* ===== 覆盖/横幅/IIFE 修正 ===== */ const applyOverrides=(src,id,name)=>{ let o=src||''; if(id){ const r=/(\bid\s*:\s*)(["'])([^"']*)(\2)/m; if(r.test(o)) o=o.replace(r,(m,p,q)=>p+q+id+q) } if(name){ const r=/(\bname\s*:\s*)(["'])([^"']*)(\2)/m; if(r.test(o)) o=o.replace(r,(m,p,q)=>p+q+name+q) } return o }; const banner=meta=>`/*!\n * 该扩展使用多扩展合并器\n * ${meta}\n */\n`; function xpAlert(msg,{title='提示',type='info'}={}) { const mask=byId('xpModalMask'),box=byId('xpModal'),m=byId('xpModalMsg'),ic=byId('xpModalIcon'),tt=byId('xpModalTitle'),ok=byId('xpModalOk'),cls=byId('xpModalClose'); tt.textContent=title;m.textContent=msg;ic.textContent=(type==='error'||type==='warn')?'!':'i'; mask.classList.remove('hidden');box.classList.remove('hidden'); const last=document.activeElement;ok.focus();let res;const p=new Promise(r=>res=r); function close(v){mask.classList.add('hidden');box.classList.add('hidden');ok.removeEventListener('click',onOk);cls.removeEventListener('click',onClose);window.removeEventListener('keydown',onKey);last&&last.focus&&last.focus();res(v)} function onOk(){close(true)} function onClose(){close(false)} function onKey(e){if(e.key==='Enter'){e.preventDefault();close(true)} if(e.key==='Escape'){e.preventDefault();close(false)}} ok.addEventListener('click',onOk);cls.addEventListener('click',onClose);window.addEventListener('keydown',onKey);return p } const normalizeIIFE=code=>{ if(!code) return ''; return code .replace(/\}\)\(\s*window\.Scratch\s*\|\|\s*\{\s*\}\s*\);?/g,'})(Scratch);') .replace(/\}\)\(\s*window\s*\.\s*Scratch\s*\|\|\\s*\{\s*\}\s*\);?/g,'})(Scratch);') .replace(/\}\)\(\s*globalThis\.Scratch\s*\|\s*\|\s*\{\s*\}\s*\);?/g,'})(Scratch);'); }; const wrapPart=(t,c)=>`\n;/* ===== ${t} ===== */\n${c||''}\n`; /* ===== 示例扩展 ===== */ const demoA=`(function(Scratch){'use strict';class A{getInfo(){return{id:'demoA',name:'示例A',color1:'#7C4DFF',blocks:[{opcode:'helloA',blockType:Scratch.BlockType.REPORTER,text:'A 说 [文本]',arguments:{文本:{type:Scratch.ArgumentType.STRING,defaultValue:'你好'} } },{opcode:'sum',blockType:Scratch.BlockType.REPORTER,text:'A 求和 [x] + [y]',arguments:{x:{type:Scratch.ArgumentType.NUMBER,defaultValue:1},y:{type:Scratch.ArgumentType.NUMBER,defaultValue:2}}}]}}helloA(a){return'A:'+a.文本}sum(a){return Number(a.x||0)+Number(a.y||0)}}Scratch&&Scratch.extensions&&Scratch.extensions.register&&Scratch.extensions.register(new A())})(Scratch);`; const demoB=`(function(Scratch){'use strict';class B{getInfo(){return{id:'demoB',name:'示例B',color1:'#06B6D4',blocks:[{opcode:'helloB',blockType:Scratch.BlockType.COMMAND,text:'B 提示 [文本]',arguments:{文本:{type:Scratch.ArgumentType.STRING,defaultValue:'Hi'} } },{opcode:'isBig',blockType:Scratch.BlockType.BOOLEAN,text:'[n] 是否大于 10？',arguments:{n:{type:Scratch.ArgumentType.NUMBER,defaultValue:5}}}]}}helloB(a){alert('B:'+a.文本)}isBig(a){return Number(a.n||0)>10}}Scratch&&Scratch.extensions&&Scratch.extensions.register&&Scratch.extensions.register(new B())})(Scratch);`; /* ====== SVG 预览：稳健识别器 ====== */ function cleanNoise(str){let s=String(str||'');s=s.replace(/["']\s*,\s*arguments\b[\s\S]*$/i,'');return s.trim()} function containsCJK(s){return /[\u2E80-\u9FFF]/.test(s)} function estimateTextWidth(text, fontSize){const per=containsCJK(text)?0.9:0.6;return Math.max(0,text.length*fontSize*per)} function fitScale(text, containerW){const w=estimateTextWidth(text,14);if(w<=0)return 1;const s=containerW/w;return Math.min(1,Math.max(0.4,s))} function shade(col,amt){const m=col&&col.match(/^#([0-9a-f]{6})$/i);if(!m)return col||'#4C97FF';const n=parseInt(m[1],16);let r=(n>>16)&255,g=(n>>8)&255,b=n&255;const c=v=>Math.max(0,Math.min(255,v));r=c(r+amt);g=c(g+amt);b=c(b+amt);return '#'+((1<<24)+(r<<16)+(g<<8)+b).toString(16).slice(1).toUpperCase()} function escapeXML(s){return String(s).replace(/[<>&"']/g,c=>({"<":"&lt;",">":">","&":"&","\"":""","'":"'"}[c]))} function escapeHTML(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML} function extractColor1(code){const m=code.match(/\bcolor1\s*:\s*(["'])(#[0-9a-fA-F]{6})\1/);return m ? m[2] : '#4C97FF';} function parseBlocksFromCode(code){ const blocks=[]; if(!code) return blocks; const color=extractColor1(code); const reObj=/\{[^{}]*?\bopcode\s*:\s*(["'])(.*?)\1[^{}]*?\bblockType\s*:\s*(?:Scratch\.)?BlockType\.([A-Z]+)[^{}]*?\btext\s*:\s*(["'])(.*?)\4[^{}]*?\}/gs; let m; while((m=reObj.exec(code))){ blocks.push({opcode:m[2],type:m[3],text:m[5],color}) } const reBT=/(?:Scratch\.)?BlockType\.([A-Z]+)/g; let mbt; const WIN=450; let unknownCount=0; while((mbt=reBT.exec(code))){ const type=mbt[1]; const idx=mbt.index; const left=Math.max(0, idx-WIN), right=Math.min(code.length, idx+WIN); const seg=code.slice(left, right); let op=null, tlabel=null; const mOp1=seg.match(/\bopcode\s*:\s*(["'])(.*?)\1/); if(mOp1) op=mOp1[2]; if(!op){ const mOp2=seg.match(/(\[\s*([^\]]+)\s*\]\s*=\s*)(["'])(.*?)\3/); if(mOp2 && /op/i.test(mOp2[4])) op=mOp2[4]; } const mTx1=seg.match(/\btext\s*:\s*(["'])([\s\S]*?)\1/); tlabel=mTx1?mTx1[2]:'（动态文本）'; const key=(op||'')+'|'+type+'|'+(tlabel||''); if(blocks.some(b=>(b.opcode||'')+'|'+b.type+'|'+(b.text||'')===key)) continue; if(!op) op=`未知块-${++unknownCount}`; blocks.push({opcode:op,type,text:tlabel,color}); } return blocks; } function tokenizeBlockText(t){ const tokens=[]; const re=/\[(.+?)\]/g; let last=0, m; while((m=re.exec(t))){ if(m.index>last) tokens.push({kind:'text',value:t.slice(last,m.index)}); tokens.push({kind:'slot',value:m[1]}); last=re.lastIndex } if(last<t.length) tokens.push({kind:'text',value:t.slice(last)}); return tokens } function measureToken(tok){if(tok.kind==='slot'){const inner=estimateTextWidth(tok.value,12);return Math.max(44,inner+16)}return estimateTextWidth(tok.value,14)} function makeShapePath(w,h,type){if(type==='REPORTER'){const r=h/2;return `<rect x="0" y="0" rx="${r}" ry="${r}" width="${w}" height="${h}" />`;} if(type==='BOOLEAN'){const dx=14;const p=`M ${dx} 0 H ${w-dx} L ${w} ${h/2} L ${w-dx} ${h} H ${dx} L 0 ${h/2} Z`;return `<path d="${p}"/>`;} return `<rect x="0" y="0" rx="8" ry="8" width="${w}" height="${h}" />`;} function renderBlockSVG({opcode,type,text,color}){ const cleaned=(text||'').replace(/["']\s*,\s*arguments\b[\s\S]*$/i,''); const isLabel=(type==='LABEL'); const padX=14, h=(type==='COMMAND')?40:(type==='BOOLEAN'?36:(isLabel?28:32)); const labelText = isLabel ? (cleaned||'（标签）') : cleaned; const tokens= isLabel ? [{kind:'text',value:labelText}] : tokenizeBlockText(labelText); let contentW=0; tokens.forEach(t=>contentW+=measureToken(t)); const w=Math.max(140,contentW+padX*2); const stroke=shade(color,-20), hi=shade(color,+16); let x=padX, svgText='',svgSlots=''; tokens.forEach(t=>{ if(t.kind==='text'){ const tokenW=measureToken(t), s=Math.min(1,Math.max(.4, (tokenW? tokenW : 1)/tokenW)), tx=x, ty=h/2+4; svgText+=`<g transform="translate(${tx},${ty})"><text x="0" y="0" font-size="14" font-family="Tahoma, Arial" fill="#fff">${escapeXML(t.value)}</text></g>`; x+=tokenW; } else { const sw=measureToken(t), sh=Math.min(22,h-12), sy=(h-sh)/2, rx=(type==='BOOLEAN')?4:6, ip=8, innerW=sw-ip*2, ty=h/2+4; svgSlots+=`<rect x="${x}" y="${sy}" width="${sw}" height="${sh}" rx="${rx}" ry="${rx}" fill="rgba(255,255,255,0.9)" stroke="${hi}" /><g transform="translate(${x+ip},${ty})"><text x="0" y="0" font-size="12" font-family="Tahoma, Arial" fill="#334155">${escapeXML(t.value)}</text></g>`; x+=sw; } }); const shape=makeShapePath(w,h,isLabel?'COMMAND':type); return `<svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" role="img" aria-label="${escapeXML(labelText)}"><defs><linearGradient id="g-${opcode}" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="${hi}"/><stop offset="100%" stop-color="${color}"/></linearGradient></defs><g><g fill="url(#g-${opcode})" stroke="${stroke}" stroke-width="1.2">${shape}</g>${svgSlots}${svgText}</g></svg>`; } function openSvgPreview(){ const cards=$$('.ext-card'); const list=[]; cards.forEach((card,i)=>{ const raw=card.querySelector('textarea.code').value||''; const blocks=parseBlocksFromCode(raw); const labelText = card.querySelector('h2')?.textContent || `扩展 ${i+1}`; if(blocks.length){blocks.forEach(b=>list.push({extIndex:i+1,label:labelText,...b}))} }); const wrap=byId('svgContainer'); wrap.innerHTML=''; if(!list.length){ wrap.innerHTML='<div class="small" style="padding:10px">未检测到 blocks（需要 BlockType / opcode / text 的线索）。</div>'; } else { const frag=document.createDocumentFragment(); list.forEach(item=>{ const card=document.createElement('div');card.className='blockCard'; const tag=`<span class="tag">${escapeHTML(item.label)}</span>`; card.innerHTML=`<div class="hd">${tag}<span style="color:${escapeHTML(item.color)}">${item.type} · ${escapeHTML(item.opcode)}</span></div><div class="cnt"></div>`; card.querySelector('.cnt').innerHTML=renderBlockSVG(item); frag.appendChild(card) }); wrap.appendChild(frag) } showSvgModal(true); } /* ===== 菜单与视图互斥 + “编辑” ===== */ const menuNew=byId('menuNew'), popupNew=byId('menuNewPopup'); const menuEdit=byId('menuEdit'), popupEdit=byId('menuEditPopup'); const menuView=byId('menuView'), popupView=byId('menuViewPopup'); function showMenuAt(trigger,menu){const r=trigger.getBoundingClientRect();menu.style.left=r.left+'px';menu.style.top=(r.bottom+4)+'px';menu.classList.remove('hidden')} function hideMenus(){popupNew.classList.add('hidden');popupView.classList.add('hidden');popupEdit.classList.add('hidden')} document.addEventListener('click',hideMenus); menuNew.addEventListener('click',e=>{ e.stopPropagation(); popupView.classList.add('hidden'); popupEdit.classList.add('hidden'); showSvgModal(false); showMenuAt(menuNew,popupNew); }); byId('miAddExt').addEventListener('click',e=>{ e.stopPropagation(); hideMenus(); showSvgModal(false); createCard(); }); menuEdit.addEventListener('click',e=>{ e.stopPropagation(); popupNew.classList.add('hidden'); popupView.classList.add('hidden'); showMenuAt(menuEdit,popupEdit); }); byId('miRename').addEventListener('click',e=>{ e.stopPropagation(); hideMenus(); openRenameModal(); }); menuView.addEventListener('click',e=>{ e.stopPropagation(); popupNew.classList.add('hidden'); popupEdit.classList.add('hidden'); showMenuAt(menuView,popupView); }); byId('miPreviewBlocks').addEventListener('click',e=>{ e.stopPropagation(); hideMenus(); openSvgPreview(); }); /* ===== 合并/导出 ===== */ function merge(){ const meta=`合并时间: ${new Date().toLocaleString()} | 合并扩展数量: ${$$('.ext-card').length}`; const parts=[]; $$('.ext-card').forEach((card,i)=>{ const id=card.querySelector('.id-input').value.trim(), nm=card.querySelector('.name-input').value.trim(), raw=card.querySelector('textarea.code').value||''; let a=applyOverrides(raw,id,nm); a=normalizeIIFE(a); parts.push(wrapPart(`EXTENSION ${i+1}`,a)) }); const out=banner(meta)+parts.join('\n')+'\n/* ====== EOF ====== */\n'; byId('output').value=out; S.mergedRelease=out; byId('downloadRelease').disabled=!out; byId('makeDataURL').disabled=!out; stat(); } byId('mergeRelease').addEventListener('click',merge); byId('downloadRelease').addEventListener('click',()=>download(S.mergedRelease,'merged-extensions.release.js')); function download(text,name){const b=new Blob([text],{type:'application/javascript'}),u=URL.createObjectURL(b),a=document.createElement('a');a.href=u;a.download=name;a.click();setTimeout(()=>URL.revokeObjectURL(u),1000)} const toDataURL=js=>`data:application/javascript;base64,${btoa(unescape(encodeURIComponent(js)))}`; byId('makeDataURL').addEventListener('click',async()=>{ if(!S.mergedRelease) return; const url=toDataURL(S.mergedRelease); try{await navigator.clipboard.writeText(url);await xpAlert('已生成并复制 Data URL 到剪贴板。',{title:'信息',type:'info'})} catch(e){await xpAlert('复制失败：'+String(e),{title:'错误',type:'error'})} }); /* ===== 工具按钮 ===== */ byId('swap').addEventListener('click',()=>{ const cs=$$('.ext-card'); if(cs.length<2) return; const [c1,c2]=cs; const sw=sel=>{const a=c1.querySelector(sel),b=c2.querySelector(sel),t=a.value;a.value=b.value;b.value=t; a.dispatchEvent(new Event('input')); b.dispatchEvent(new Event('input')); }; sw('textarea.code'); sw('.id-input'); sw('.name-input'); }); byId('clearAll').addEventListener('click',()=>{ $$('.ext-card').forEach(c=>{ c.querySelector('.id-input').value=''; c.querySelector('.name-input').value=''; const ta=c.querySelector('textarea.code'); ta.value=''; ta.dataset.filesize='0'; ta.dispatchEvent(new Event('input')); }); S.mergedRelease=''; byId('downloadRelease').disabled=true; byId('makeDataURL').disabled=true; byId('output').value=''; stat(); }); const getId=c=>(c.match(/\bid\s*:\s*['"]([^'"]+)['"]/)||[])[1]||''; const getOps=c=>Array.from(c.matchAll(/\bopcode\s*:\s*['"]([^'"]+)['"]/g)).map(m=>m[1]); byId('scan').addEventListener('click',()=>{ const cs=$$('.ext-card'); let msgs=[]; const ids=new Map(),ops=new Map(); cs.forEach((card,i)=>{ const id=card.querySelector('.id-input').value.trim(), nm=card.querySelector('.name-input').value.trim(), raw=card.querySelector('textarea.code').value||''; const a=applyOverrides(raw,id,nm),cid=getId(a); if(cid){(ids.get(cid)||ids.set(cid,[]).get(cid)).push(i+1)} getOps(a).forEach(op=>{(ops.get(op)||ops.set(op,[]).get(op)).push(i+1)}) }); const dupID=[...ids.entries()].filter(([,arr])=>arr.length>1), dupOp=[...ops.entries()].filter(([,arr])=>arr.length>1); if(dupID.length){msgs.push('发现重复扩展 ID：'); dupID.forEach(([id,arr])=>msgs.push(`- ${id} 出现在扩展 ${arr.join(', ')} 中`)); msgs.push('建议为重复的扩展设置不同的覆盖 ID。')} if(dupOp.length){msgs.push('发现重复 opcode：'); dupOp.slice(0,50).forEach(([op,arr])=>msgs.push(`- ${op} 出现在扩展 ${arr.join(', ')} 中`)); if(dupOp.length>50)msgs.push('…更多重复已省略'); msgs.push('建议为其中一侧更名避免运行期覆盖。')} if(!msgs.length)msgs=['未发现明显冲突。']; xpAlert(msgs.join('\n'),{title:'扫描结果',type:(dupID.length||dupOp.length)?'warn':'info'}) }); /* ===== 统计（合并后展示大小） ===== */ function stat(){ const pill = byId('statBytes'); if (!S.mergedRelease) { pill.textContent = '0 B'; pill.classList.add('hidden'); return; } pill.textContent = fmt(bytes(S.mergedRelease)); pill.classList.remove('hidden'); } /* ===== 主题与会话恢复（含标题持久化） ===== */ function applyTheme(t){ document.body.classList.remove('theme-olive','theme-silver'); if(t==='olive') document.body.classList.add('theme-olive'); if(t==='silver') document.body.classList.add('theme-silver'); localStorage.setItem('merge2:theme',t); } function bindThemeDots(sel){ $$(sel).forEach(d=>d.addEventListener('click',()=>applyTheme(d.dataset.theme))) } bindThemeDots('.dot'); window.addEventListener('beforeunload',()=>{ const dump=$$('.ext-card').map((c,i)=>({ fixed:c.dataset.fixed==='true', id:c.querySelector('.id-input').value, name:c.querySelector('.name-input').value, code:c.querySelector('textarea.code').value, title:c.querySelector('h2')?.textContent || `扩展 ${i+1}`, custom: !!c.querySelector('h2')?.dataset.custom })); localStorage.setItem('merge2:cardsDump',JSON.stringify(dump)) }); window.addEventListener('DOMContentLoaded',()=>{ applyTheme(localStorage.getItem('merge2:theme')||'blue'); const dump=localStorage.getItem('merge2:cardsDump'); if(dump){ const arr=JSON.parse(dump); if(Array.isArray(arr)&&arr.length){ byId('extGrid').innerHTML=''; arr.forEach(()=>{createCard();}); const cards=$$('.ext-card'); cards.forEach((c,i)=>{ if(i<2) c.dataset.fixed='true'; c.querySelector('.id-input').value=arr[i]?.id||''; c.querySelector('.name-input').value=arr[i]?.name||''; const ta=c.querySelector('textarea.code'); ta.value=arr[i]?.code||''; ta.dataset.filesize='0'; const h=c.querySelector('h2'); const t = arr[i]?.title || `扩展 ${i+1}`; h.textContent = t; if(arr[i]?.custom || (t !== `扩展 ${i+1}`)) h.dataset.custom='1'; ta.addEventListener('input', updateMergeVisibility); decorateCodeTextArea(ta); // 恢复后也装饰代码框（波纹/高亮） }); reindex(true); } } else { // 初始两张卡片也需要装饰 $$('.ext-card textarea.code').forEach(decorateCodeTextArea); } stat(); updateMergeVisibility(); }); /* ===== 复制与换行 ===== */ const out=byId('output'); byId('copyOutput').addEventListener('click',async()=>{ if(!out.value){await xpAlert('没有可复制的内容。',{title:'提示',type:'warn'});return} try{await navigator.clipboard.writeText(out.value);await xpAlert('已复制到剪贴板。',{title:'信息',type:'info'})} catch(e){await xpAlert('复制失败：'+e,{title:'错误',type:'error'})} }); const wrapBtn=byId('wrapToggle'); let wrap=false; function setWrap(on){ if(on){out.style.whiteSpace='pre-wrap';out.style.wordBreak='break-all';wrapBtn.textContent='自动换行: 开'} else {out.style.whiteSpace='pre';out.style.wordBreak='normal';wrapBtn.textContent='自动换行: 关'} } wrapBtn.addEventListener('click',()=>setWrap(wrap=!wrap)); setWrap(false); /* ===== 全屏/关闭 ===== */ const btnMax=byId('btnMax'), btnClose=byId('btnClose'); const isFS=()=>document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement; const enterFS=()=>{const el=document.documentElement;(el.requestFullscreen||el.webkitRequestFullscreen||el.mozRequestFullScreen||el.msRequestFullscreen)?.call(el)}; const exitFS=()=>{(document.exitFullscreen||document.webkitExitFullscreen||document.mozCancelFullScreen||document.msExitFullscreen)?.call(document)}; btnMax.addEventListener('click',()=>{isFS()?exitFS():enterFS()}); btnClose.addEventListener('click',()=>{window.close();setTimeout(()=>document.body.classList.add('is-closed'),50)}); byId('btnReopen')?.addEventListener('click',()=>document.body.classList.remove('is-closed')); /* ===== 动态卡片构建 ===== */ function addBtns(card,idx){ const box=card.querySelector('.btns'); if(box) box.innerHTML=''; if(idx<=2){ const fill=document.createElement('button'); fill.className='ghost fill-demo'; fill.textContent=idx===1?'填充示例 A':'填充示例 B'; fill.dataset.demo=idx===1?'A':'B'; fill.addEventListener('click',e=>{ const k=e.currentTarget.getAttribute('data-demo'); const ta=card.querySelector('textarea.code'); ta.value=(k==='A')?demoA:demoB; ta.dataset.filesize='0'; ta.dispatchEvent(new Event('input')); }); box && box.appendChild(fill); } if(card.dataset.fixed!=='true'){ const del=document.createElement('button'); del.className='ghost remove-card'; del.textContent='移除'; del.title='移除此扩展'; del.addEventListener('click',()=>{ if(card.dataset.fixed==='true')return; card.style.pointerEvents='none'; card.classList.add('closing'); card.addEventListener('animationend',()=>{ card.remove(); reindex(); updateMergeVisibility(); }, {once:true}); }); box && box.appendChild(del); } // URL 获取 const urlBtn=card.querySelector('.url-btn'); const urlInput=card.querySelector('.url-input'); const ta=card.querySelector('textarea.code'); if(urlBtn && urlInput && ta){ const refreshUrlBtn=()=>{ const has=(urlInput.value||'').trim().length>0; urlBtn.disabled=!has; }; refreshUrlBtn(); urlInput.addEventListener('input', refreshUrlBtn); urlInput.addEventListener('keydown',e=>{ if(e.key==='Enter'){ const has=(urlInput.value||'').trim(); if(has){ e.preventDefault(); urlBtn.click(); } } }); urlBtn.addEventListener('click',()=>loadFromURL(urlInput.value,ta,urlBtn)); } // 源码输入监听 const ta2=card.querySelector('textarea.code'); if(ta2){ ta2.addEventListener('input', updateMergeVisibility); decorateCodeTextArea(ta2); } } function reindex(preserveCustom=false){ $$('.ext-card').forEach((c,i)=>{ const h=c.querySelector('h2'); if(!preserveCustom && !h.dataset.custom){ h.textContent=`扩展 ${i+1}`; } addBtns(c,i+1) }) } function wireDrop(card){ const drop=card.querySelector('.drop'), input=drop.querySelector('input[type=file]'); const pick=()=>input.click(); drop.addEventListener('click',pick); drop.addEventListener('dragover',e=>{e.preventDefault();drop.classList.add('drag')}); drop.addEventListener('dragleave',()=>drop.classList.remove('drag')); drop.addEventListener('drop',e=>{e.preventDefault();drop.classList.remove('drag');const f=e.dataTransfer.files?.[0];if(!f)return;load(f,card.querySelector('textarea.code'))}); input.addEventListener('change',e=>{const f=e.target.files?.[0];if(!f)return;load(f,card.querySelector('textarea.code'))}); } function createCard(){ const c=document.createElement('section'); c.className='card ext-card'; c.innerHTML=`
扩展
<div class="body"> <div class="row"> <div> <label>从文件载入（.js）</label> <div class="drop">拖拽到此 / 点击选择 <input type="file" accept=".js" style="display:none"/></div> </div> <div> <label>覆盖 ID（可选）</label> <input class="input id-input" placeholder="例如: myExt"/> </div> </div> <div class="row" style="margin-top:8px"> <div> <label>覆盖 Name（可选）</label> <input class="input name-input" placeholder="例如: 扩展"/> </div> <div class="btns" style="align-items:end;justify-content:flex-end"></div> </div> <!-- URL 行 --> <div class="row" style="margin-top:8px"> <div class="full"> <label>从 URL 载入（支持 https:// 与 data:）</label> <div class="url-inline"> <input class="input url-input" placeholder="例如: https://example.com/your-ext.js"/> <button class="ghost url-btn" disabled>获取</button> </div> </div> </div> <div style="margin-top:8px"> <label>源码</label> <textarea class="code" spellcheck="false" placeholder="将扩展的 JS 源码粘贴到这里，或使用上方文件/URL 载入"></textarea>
  </div>
</div>`;
byId(‘extGrid’).appendChild©; wireDrop©; reindex(); updateMergeVisibility();
}

/* 初始卡片接入拖拽 */
$$(‘.ext-card’).forEach(c=>{ wireDrop©; const ta=c.querySelector(‘textarea.code’); if(ta){ ta.addEventListener(‘input’, updateMergeVisibility); } });
reindex();

/* ===== SVG 弹窗控制 ===== */
const svgMask=byId(‘svgModalMask’), svgModal=byId(‘svgModal’), svgClose=byId(‘svgModalClose’);
function showSvgModal(on){svgMask.style.display=on?‘block’:‘none’;svgModal.style.display=on?‘block’:‘none’}
svgClose.addEventListener(‘click’,()=>showSvgModal(false));
svgMask.addEventListener(‘click’,()=>showSvgModal(false));
window.addEventListener(‘keydown’,e=>{if(e.key===‘Escape’)showSvgModal(false)});

/* ===== 重命名对话框逻辑 ===== */
const renameMask=byId(‘renameMask’), renameModal=byId(‘renameModal’), renameClose=byId(‘renameClose’);
const renameSel=byId(‘renameSelect’), renameInput=byId(‘renameInput’);
const renameOk=byId(‘renameOk’), renameCancel=byId(‘renameCancel’);

function openRenameModal(){
const cards=$$(‘.ext-card’);
renameSel.innerHTML=‘’;
cards.forEach((c,i)=>{
const h=c.querySelector(‘h2’)?.textContent || 扩展 ${i+1};
const opt=document.createElement(‘option’);
opt.value=String(i); opt.textContent=h;
renameSel.appendChild(opt);
});
renameInput.value = cards[0]?.querySelector(‘h2’)?.textContent || ‘扩展 1’;
renameMask.classList.remove(‘hidden’); renameModal.classList.remove(‘hidden’);
renameInput.focus(); renameInput.select();
}
function closeRenameModal(){
renameMask.classList.add(‘hidden’); renameModal.classList.add(‘hidden’);
}
renameSel.addEventListener(‘change’,()=>{
const i=Number(renameSel.value)||0;
const cards=$$(‘.ext-card’);
renameInput.value = cards[i]?.querySelector(‘h2’)?.textContent || 扩展 ${i+1};
});
renameOk.addEventListener(‘click’,()=>{
const idx=Number(renameSel.value)||0;
const name=(renameInput.value||‘’).trim();
const cards=$$(‘.ext-card’); const card=cards[idx];
if(!card) return closeRenameModal();
if(!name){ return xpAlert(‘名称不能为空’,{title:‘提示’,type:‘warn’}); }
const h=card.querySelector(‘h2’); h.textContent=name; h.dataset.custom=‘1’;
closeRenameModal();
});
renameCancel.addEventListener(‘click’,closeRenameModal);
renameClose.addEventListener(‘click’,closeRenameModal);
renameMask.addEventListener(‘click’,closeRenameModal);
window.addEventListener(‘keydown’,e=>{
if(renameModal.classList.contains(‘hidden’)) return;
if(e.key===‘Escape’){ e.preventDefault(); closeRenameModal(); }
if(e.key===‘Enter’){ e.preventDefault(); renameOk.click(); }
});

/* ====== 根据是否有“源码”自动显示/隐藏“合并 与 导出”块 ====== */
function anyCodePresent(){
return $$(‘.ext-card textarea.code’).some(ta => (ta.value||‘’).trim().length>0);
}
function updateMergeVisibility(){
const show = anyCodePresent();
const card = byId(‘mergeCard’);
if(!card) return;
card.classList.toggle(‘hidden’, !show);
}

/* ====== 代码框装饰：主题联动的聚焦高亮 + 墨水波纹（无 canvas） ====== */
function hexToRgb(hex){
const m = (hex||‘’).trim().match(/^#?([0-9a-f]{6})$/i);
if(!m) return {r:0,g:0,b:0};
const n=parseInt(m[1],16);
return {r:(n>>16)&255,g:(n>>8)&255,b:n&255};
}
function getAccent(){
const cs = getComputedStyle(document.body);
const hex = cs.getPropertyValue(‘–accent’).trim() || ‘#3a6ea5’;
const {r,g,b}=hexToRgb(hex);
return {hex,r,g,b};
}
function decorateCodeTextArea(ta){
if(!ta || ta.dataset.decorated===‘1’) return;
ta.dataset.decorated=‘1’;
const wrap=document.createElement(‘div’);
wrap.className=‘code-wrap’;
ta.parentNode.insertBefore(wrap, ta);
wrap.appendChild(ta);

// 聚焦时卡片高亮由 CSS 的 :focus-within 驱动，这里只做波纹
function spawnInk(e){
const acc=getAccent();
const rect=ta.getBoundingClientRect();
const x=(e.clientX|| (rect.left+rect.width/2)) - rect.left;
const y=(e.clientY|| (rect.top+rect.height/2)) - rect.top;
const s=document.createElement(‘span’);
s.className=‘ink’;
s.style.left=(x-4)+‘px’;
s.style.top=(y-4)+‘px’;
s.style.width=‘8px’;
s.style.height=‘8px’;
s.style.background=rgba(${acc.r},${acc.g},${acc.b},.35);
s.style.boxShadow=0 0 0 2px rgba(${acc.r},${acc.g},${acc.b},.06);
s.style.animation=‘codeInk .55s ease-out forwards’;
wrap.appendChild(s);
s.addEventListener(‘animationend’,()=>s.remove(),{once:true});
}
ta.addEventListener(‘mousedown’,spawnInk);
// 键盘聚焦也给一个居中小波纹
ta.addEventListener(‘focus’,()=>spawnInk({clientX:ta.getBoundingClientRect().left+ta.clientWidth/2,clientY:ta.getBoundingClientRect().top+8}));
}

/* 初始两块代码框装饰（若未在恢复逻辑中处理） */
$$(‘textarea.code’).forEach(decorateCodeTextArea);
</script>

</body> </html>
