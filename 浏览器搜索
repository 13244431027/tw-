class BlueSearchExtension {
    constructor(runtime) {
        this.runtime = runtime;
        this.searchContainer = null;
        this.dockContainer = null;
        this.currentEngine = 'google';
        this.isEditingDock = false;
        
        // é»˜è®¤æœç´¢å¼•æ“é…ç½®
        this.searchEngines = [
            { name: 'Google', value: 'google', color: '#4285F4' },
            { name: 'Bing', value: 'bing', color: '#008373' },
            { name: 'ç™¾åº¦', value: 'baidu', color: '#2932E1' },
            { name: 'DuckDuckGo', value: 'duckduckgo', color: '#DE5833' },
            { name: 'YouTube', value: 'youtube', color: '#FF0000' },
            { name: 'è‡ªå®šä¹‰', value: 'custom', color: '#666666' }
        ];
        
        // é»˜è®¤Docké¡¹ç›®
        this.dockItems = JSON.parse(localStorage.getItem('bluesearch_dock_items')) || [
            { icon: 'ğŸ“º', name: 'å“”å“©å“”å“©', url: 'https://www.bilibili.com' },
            { icon: 'ğŸµ', name: 'æŠ–éŸ³', url: 'https://www.douyin.com' },
            { icon: 'âœ‰ï¸', name: 'QQé‚®ç®±', url: 'https://mail.qq.com' },
            { icon: 'ğŸ¶', name: 'ç½‘æ˜“äº‘éŸ³ä¹', url: 'https://music.163.com' }
        ];
    }

    getInfo() {
        return {
            id: 'bluesearch',
            name: 'BlueSearch',
            blocks: [
                {
                    opcode: 'createFullscreenSearch',
                    blockType: Scratch.BlockType.COMMAND,
                    text: 'åˆ›å»ºå…¨å±BlueSearch æ ‡é¢˜ [TITLE] é»˜è®¤å¼•æ“ [ENGINE] èƒŒæ™¯è‰² [COLOR] æ¨¡ç³Šåº¦ [BLUR]',
                    arguments: {
                        TITLE: {
                            type: Scratch.ArgumentType.STRING,
                            defaultValue: 'BlueSearch'
                        },
                        ENGINE: {
                            type: Scratch.ArgumentType.STRING,
                            menu: 'searchEngines',
                            defaultValue: 'google'
                        },
                        COLOR: {
                            type: Scratch.ArgumentType.STRING,
                            defaultValue: 'rgba(255, 255, 255, 0.15)'
                        },
                        BLUR: {
                            type: Scratch.ArgumentType.NUMBER,
                            defaultValue: '12'
                        }
                    }
                },
                {
                    opcode: 'closeSearch',
                    blockType: Scratch.BlockType.COMMAND,
                    text: 'å…³é—­BlueSearchç•Œé¢'
                }
            ],
            menus: {
                searchEngines: {
                    acceptReporters: true,
                    items: this.searchEngines.map(engine => engine.value)
                }
            }
        };
    }

    // è¾…åŠ©æ–¹æ³•ï¼šåˆ›å»ºå¸¦æœ‰åŸºæœ¬æ ·å¼çš„å…ƒç´ 
    createStyledElement(tag, styles = {}, textContent = '') {
        const element = document.createElement(tag);
        Object.assign(element.style, styles);
        if (textContent) element.textContent = textContent;
        return element;
    }

    // è¾…åŠ©æ–¹æ³•ï¼šåˆ›å»ºæŒ‰é’®å…ƒç´ 
    createButton(text, styles = {}, hoverStyles = {}) {
        const button = this.createStyledElement('button', {
            padding: '8px 16px',
            borderRadius: '20px',
            border: 'none',
            backgroundColor: 'rgba(0, 136, 255, 0.7)',
            color: 'white',
            fontSize: '14px',
            cursor: 'pointer',
            transition: 'all 0.3s ease',
            boxShadow: '0 2px 4px rgba(0, 0, 0, 0.2)',
            backdropFilter: 'blur(5px)',
            border: '1px solid rgba(255, 255, 255, 0.2)',
            ...styles
        }, text);

        if (Object.keys(hoverStyles).length > 0) {
            button.onmouseover = () => Object.assign(button.style, hoverStyles);
            button.onmouseout = () => Object.assign(button.style, styles);
        }

        return button;
    }

    // åˆ›å»ºç‰ˆæƒä¿¡æ¯
    createCopyrightNotice() {
        const copyright = this.createStyledElement('div', {
            position: 'fixed',
            left: '20px',
            bottom: '20px',
            color: 'rgba(255, 255, 255, 0.7)',
            fontSize: '12px',
            fontFamily: 'Arial, sans-serif',
            textShadow: '0 1px 2px rgba(0, 0, 0, 0.3)',
            zIndex: '10000'
        }, 'Â©BlueStudio 2025');
        
        return copyright;
    }

    // åˆ›å»ºæœç´¢ä¸»ç•Œé¢
    createFullscreenSearch(args) {
        this.closeSearch(); // å…ˆå…³é—­å·²æœ‰ç•Œé¢

        const { TITLE: title = 'BlueSearch', ENGINE: engine = 'google', COLOR: color, BLUR: blur } = args;
        this.currentEngine = engine;

        // åˆ›å»ºä¸»å®¹å™¨
        this.searchContainer = this.createStyledElement('div', {
            position: 'fixed',
            top: '0',
            left: '0',
            width: '100vw',
            height: '100vh',
            display: 'flex',
            flexDirection: 'column',
            justifyContent: 'space-between',
            alignItems: 'center',
            zIndex: '9999',
            backdropFilter: `blur(${blur}px)`,
            overflow: 'hidden'
        });

        // åˆ›å»ºå†…å®¹åŒºåŸŸ
        const content = this.createContentArea(title, color);
        this.searchContainer.appendChild(content);

        // åˆ›å»ºDockæ 
        this.createDockArea();

        // æ·»åŠ ç‰ˆæƒä¿¡æ¯
        const copyright = this.createCopyrightNotice();
        this.searchContainer.appendChild(copyright);

        // æ·»åŠ åˆ°æ–‡æ¡£
        document.body.appendChild(this.searchContainer);
    }

    // åˆ›å»ºå†…å®¹åŒºåŸŸ
    createContentArea(title, color) {
        const content = this.createStyledElement('div', {
            width: 'calc(100% - 40px)',
            maxWidth: '800px',
            padding: '40px',
            borderRadius: '20px',
            backgroundColor: color,
            boxShadow: '0 8px 32px rgba(0, 0, 0, 0.2)',
            backdropFilter: 'blur(5px)',
            border: '1px solid rgba(255, 255, 255, 0.2)',
            boxSizing: 'border-box',
            marginTop: '60px'
        });

        // æ ‡é¢˜
        const titleElement = this.createStyledElement('h1', {
            color: 'white',
            textAlign: 'center',
            marginBottom: '30px',
            textShadow: '0 2px 4px rgba(0, 0, 0, 0.2)',
            fontFamily: 'Arial, sans-serif',
            fontSize: '2.5rem'
        }, title);

        // æœç´¢å¼•æ“é€‰æ‹©å™¨
        const engineSelector = this.createEngineSelector();
        
        // æœç´¢è¾“å…¥æ¡†
        const searchInput = this.createSearchInput();

        content.appendChild(titleElement);
        content.appendChild(engineSelector);
        content.appendChild(searchInput);

        return content;
    }

    // åˆ›å»ºæœç´¢å¼•æ“é€‰æ‹©å™¨
    createEngineSelector() {
        const container = this.createStyledElement('div', {
            display: 'flex',
            justifyContent: 'center',
            marginBottom: '20px',
            gap: '10px',
            flexWrap: 'wrap'
        });

        this.searchEngines.forEach(engine => {
            const btn = this.createButton(engine.name, {
                backgroundColor: engine.value === this.currentEngine ? 
                    this.hexToRgba(engine.color, 0.7) : 'rgba(255, 255, 255, 0.1)'
            }, {
                transform: 'translateY(-2px)',
                boxShadow: '0 4px 8px rgba(0, 0, 0, 0.2)'
            });

            btn.onclick = () => {
                this.currentEngine = engine.value;
                container.querySelectorAll('button').forEach(b => {
                    const eng = this.searchEngines.find(e => e.value === b.value);
                    b.style.backgroundColor = b.value === this.currentEngine ? 
                        this.hexToRgba(eng.color, 0.7) : 'rgba(255, 255, 255, 0.1)';
                });
                
                if (engine.value === 'custom') {
                    this.promptCustomSearchUrl();
                }
            };
            
            container.appendChild(btn);
        });

        return container;
    }

    // åˆ›å»ºæœç´¢è¾“å…¥æ¡†
    createSearchInput() {
        const container = this.createStyledElement('div', {
            position: 'relative',
            width: '100%',
            marginBottom: '15px'
        });

        const input = this.createStyledElement('input', {
            type: 'text',
            width: '100%',
            padding: '15px 50px 15px 20px',
            borderRadius: '50px',
            border: 'none',
            backgroundColor: 'rgba(255, 255, 255, 0.3)',
            color: 'white',
            fontSize: '16px',
            outline: 'none',
            boxShadow: '0 4px 6px rgba(0, 0, 0, 0.1)',
            boxSizing: 'border-box'
        });
        input.placeholder = 'è¾“å…¥æœç´¢å†…å®¹...';

        const searchButton = this.createButton('ğŸ”', {
            position: 'absolute',
            right: '10px',
            top: '50%',
            transform: 'translateY(-50%)',
            width: '30px',
            height: '30px',
            padding: '0',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center'
        }, {
            backgroundColor: 'rgba(0, 136, 255, 0.9)',
            transform: 'translateY(-50%) scale(1.1)'
        });

        searchButton.onclick = () => this.performSearch(input.value, input);

        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchButton.click();
        });

        container.appendChild(input);
        container.appendChild(searchButton);

        return container;
    }

    // æ‰§è¡Œæœç´¢
    performSearch(query, inputElement) {
        if (!query) return;
        
        const searchUrl = this.getSearchUrl(this.currentEngine, query);
        if (searchUrl) {
            window.open(searchUrl, '_blank');
            if (inputElement) inputElement.value = '';
        }
    }

    // åˆ›å»ºDockåŒºåŸŸ
    createDockArea() {
        this.dockContainer = this.createStyledElement('div', {
            position: 'fixed',
            bottom: '20px',
            left: '50%',
            transform: 'translateX(-50%)',
            display: 'flex',
            justifyContent: 'center',
            alignItems: 'center',
            backgroundColor: 'rgba(255, 255, 255, 0.2)',
            backdropFilter: 'blur(10px)',
            borderRadius: '20px',
            padding: '10px 20px',
            boxShadow: '0 4px 12px rgba(0, 0, 0, 0.1)',
            transition: 'all 0.3s ease',
            border: '1px solid rgba(255, 255, 255, 0.2)'
        });

        const editButton = this.createButton('ç¼–è¾‘', {
            marginLeft: '20px'
        }, {
            backgroundColor: 'rgba(0, 136, 255, 0.9)'
        });

        editButton.onclick = () => this.toggleDockEditMode();

        this.dockContainer.appendChild(editButton);
        this.searchContainer.appendChild(this.dockContainer);

        // åˆ›å»ºDockè®¾ç½®é¢æ¿
        this.createDockSettingsPanel();
        
        // æ›´æ–°Dockæ˜¾ç¤º
        this.updateDock();
    }

    // åˆ›å»ºDockè®¾ç½®é¢æ¿
    createDockSettingsPanel() {
        this.dockSettingsPanel = this.createStyledElement('div', {
            position: 'fixed',
            top: '50%',
            left: '50%',
            transform: 'translate(-50%, -50%)',
            width: '80%',
            maxWidth: '600px',
            padding: '20px',
            backgroundColor: 'rgba(30, 30, 30, 0.9)',
            backdropFilter: 'blur(10px)',
            borderRadius: '20px',
            boxShadow: '0 8px 32px rgba(0, 0, 0, 0.5)',
            zIndex: '10000',
            display: 'none',
            border: '1px solid rgba(255, 255, 255, 0.3)'
        });

        const settingsTitle = this.createStyledElement('h2', {
            color: 'white',
            textAlign: 'center',
            marginBottom: '20px'
        }, 'Dockæ è®¾ç½®');

        this.dockItemsContainer = this.createStyledElement('div', {
            maxHeight: '300px',
            overflowY: 'auto',
            marginBottom: '20px'
        });

        const addNewItemBtn = this.createButton('+ æ·»åŠ æ–°é¡¹ç›®', {
            width: '100%',
            padding: '10px',
            marginBottom: '20px'
        }, {
            backgroundColor: 'rgba(0, 136, 255, 0.9)'
        });

        addNewItemBtn.onclick = () => this.addNewDockItem();

        const saveBtn = this.createButton('ä¿å­˜è®¾ç½®', {
            width: '100%',
            padding: '10px',
            backgroundColor: 'rgba(76, 175, 80, 0.7)'
        }, {
            backgroundColor: 'rgba(76, 175, 80, 0.9)'
        });

        saveBtn.onclick = () => this.saveDockSettings();

        this.dockSettingsPanel.appendChild(settingsTitle);
        this.dockSettingsPanel.appendChild(this.dockItemsContainer);
        this.dockSettingsPanel.appendChild(addNewItemBtn);
        this.dockSettingsPanel.appendChild(saveBtn);
        
        this.searchContainer.appendChild(this.dockSettingsPanel);
    }

    // æ›´æ–°Dockæ˜¾ç¤º
    updateDock() {
        if (!this.dockContainer) return;
        
        // ä¿ç•™ç¼–è¾‘æŒ‰é’®
        const editButton = this.dockContainer.querySelector('button');
        this.dockContainer.innerHTML = '';
        if (editButton) this.dockContainer.appendChild(editButton);
        
        this.dockItems.forEach((item, index) => {
            const dockItem = this.createStyledElement('div', {
                display: 'flex',
                flexDirection: 'column',
                alignItems: 'center',
                margin: '0 15px',
                cursor: 'pointer',
                transition: 'all 0.3s ease',
                position: 'relative'
            });

            const icon = this.createStyledElement('div', {
                fontSize: '24px',
                marginBottom: '5px'
            }, item.icon);

            const name = this.createStyledElement('div', {
                fontSize: '12px',
                color: 'white'
            }, item.name);

            const deleteBtn = this.createStyledElement('div', {
                position: 'absolute',
                top: '-8px',
                right: '-8px',
                width: '16px',
                height: '16px',
                borderRadius: '50%',
                backgroundColor: 'rgba(255, 59, 48, 0.8)',
                color: 'white',
                fontSize: '12px',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                cursor: 'pointer',
                display: this.isEditingDock ? 'flex' : 'none'
            }, 'Ã—');

            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                this.dockItems.splice(index, 1);
                this.updateDock();
            };

            dockItem.onmouseover = () => {
                dockItem.style.transform = 'translateY(-5px)';
                dockItem.style.opacity = '0.9';
            };
            
            dockItem.onmouseout = () => {
                dockItem.style.transform = 'translateY(0)';
                dockItem.style.opacity = '1';
            };
            
            dockItem.onclick = () => {
                if (this.isEditingDock) {
                    this.editDockItem(index);
                } else {
                    window.open(item.url, '_blank');
                }
            };

            dockItem.appendChild(icon);
            dockItem.appendChild(name);
            dockItem.appendChild(deleteBtn);
            
            this.dockContainer.insertBefore(dockItem, editButton);
        });
    }

    // ç¼–è¾‘Docké¡¹ç›®
    editDockItem(index) {
        const item = this.dockItems[index];
        const newIcon = prompt('è¾“å…¥æ–°çš„å›¾æ ‡(emoji):', item.icon);
        if (newIcon !== null) item.icon = newIcon;
        
        const newName = prompt('è¾“å…¥æ–°çš„åç§°:', item.name);
        if (newName !== null) item.name = newName;
        
        const newUrl = prompt('è¾“å…¥æ–°çš„URL:', item.url);
        if (newUrl !== null) item.url = newUrl;
        
        this.updateDock();
    }

    // åˆ‡æ¢Dockç¼–è¾‘æ¨¡å¼
    toggleDockEditMode() {
        this.isEditingDock = !this.isEditingDock;
        this.updateDock();
        this.showDockSettingsPanel();
    }

    // æ˜¾ç¤º/éšè—Dockè®¾ç½®é¢æ¿
    showDockSettingsPanel() {
        if (this.isEditingDock) {
            this.dockSettingsPanel.style.display = 'block';
            this.updateDockSettingsPanel();
        } else {
            this.dockSettingsPanel.style.display = 'none';
        }
    }

    // æ›´æ–°Dockè®¾ç½®é¢æ¿å†…å®¹
    updateDockSettingsPanel() {
        this.dockItemsContainer.innerHTML = '';
        
        this.dockItems.forEach((item, index) => {
            const itemContainer = this.createStyledElement('div', {
                display: 'flex',
                alignItems: 'center',
                marginBottom: '10px',
                padding: '10px',
                backgroundColor: 'rgba(255, 255, 255, 0.1)',
                borderRadius: '10px'
            });

            const iconInput = this.createStyledElement('input', {
                type: 'text',
                width: '50px',
                marginRight: '10px',
                padding: '5px',
                borderRadius: '5px',
                border: 'none',
                backgroundColor: 'rgba(255, 255, 255, 0.3)',
                color: 'white'
            });
            iconInput.value = item.icon;

            const nameInput = this.createStyledElement('input', {
                type: 'text',
                flex: '1',
                marginRight: '10px',
                padding: '5px',
                borderRadius: '5px',
                border: 'none',
                backgroundColor: 'rgba(255, 255, 255, 0.3)',
                color: 'white'
            });
            nameInput.value = item.name;

            const urlInput = this.createStyledElement('input', {
                type: 'text',
                flex: '2',
                marginRight: '10px',
                padding: '5px',
                borderRadius: '5px',
                border: 'none',
                backgroundColor: 'rgba(255, 255, 255, 0.3)',
                color: 'white'
            });
            urlInput.value = item.url;

            const deleteBtn = this.createButton('åˆ é™¤', {
                padding: '5px 10px',
                backgroundColor: 'rgba(255, 59, 48, 0.7)'
            }, {
                backgroundColor: 'rgba(255, 59, 48, 0.9)'
            });

            deleteBtn.onclick = () => {
                this.dockItems.splice(index, 1);
                this.updateDockSettingsPanel();
            };

            const updateItem = () => {
                this.dockItems[index] = {
                    icon: iconInput.value,
                    name: nameInput.value,
                    url: urlInput.value
                };
            };

            iconInput.addEventListener('change', updateItem);
            nameInput.addEventListener('change', updateItem);
            urlInput.addEventListener('change', updateItem);

            itemContainer.appendChild(iconInput);
            itemContainer.appendChild(nameInput);
            itemContainer.appendChild(urlInput);
            itemContainer.appendChild(deleteBtn);
            
            this.dockItemsContainer.appendChild(itemContainer);
        });
    }

    // æ·»åŠ æ–°Docké¡¹ç›®
    addNewDockItem() {
        this.dockItems.push({
            icon: 'ğŸ”—',
            name: 'æ–°ç½‘ç«™',
            url: 'https://'
        });
        this.updateDockSettingsPanel();
    }

    // ä¿å­˜Dockè®¾ç½®
    saveDockSettings() {
        localStorage.setItem('bluesearch_dock_items', JSON.stringify(this.dockItems));
        this.isEditingDock = false;
        this.updateDock();
        this.dockSettingsPanel.style.display = 'none';
    }

    // æç¤ºè‡ªå®šä¹‰æœç´¢å¼•æ“URL
    promptCustomSearchUrl() {
        const customUrl = prompt("è¯·è¾“å…¥è‡ªå®šä¹‰æœç´¢å¼•æ“URLæ¨¡æ¿ï¼ˆä½¿ç”¨{query}ä½œä¸ºæŸ¥è¯¢å‚æ•°å ä½ç¬¦ï¼‰:", 
            localStorage.getItem('bluesearch_custom_url') || 'https://example.com/search?q={query}');
        if (customUrl) {
            localStorage.setItem('bluesearch_custom_url', customUrl);
        }
    }

    // è·å–æœç´¢URL
    getSearchUrl(engine, query) {
        if (!query) return null;
        
        switch (engine) {
            case 'google': return `https://www.google.com/search?q=${encodeURIComponent(query)}`;
            case 'bing': return `https://www.bing.com/search?q=${encodeURIComponent(query)}`;
            case 'baidu': return `https://www.baidu.com/s?wd=${encodeURIComponent(query)}`;
            case 'duckduckgo': return `https://duckduckgo.com/?q=${encodeURIComponent(query)}`;
            case 'youtube': return `https://www.youtube.com/results?search_query=${encodeURIComponent(query)}`;
            case 'custom':
                const customUrl = localStorage.getItem('bluesearch_custom_url');
                return customUrl ? customUrl.replace('{query}', encodeURIComponent(query)) : null;
            default: return `https://www.google.com/search?q=${encodeURIComponent(query)}`;
        }
    }

    // è¾…åŠ©æ–¹æ³•ï¼šå°†åå…­è¿›åˆ¶é¢œè‰²è½¬æ¢ä¸ºRGBA
    hexToRgba(hex, alpha = 1) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    // å…³é—­æœç´¢ç•Œé¢
    closeSearch() {
        if (this.searchContainer) {
            document.body.removeChild(this.searchContainer);
            this.searchContainer = null;
            this.dockContainer = null;
        }
    }
}

Scratch.extensions.register(new BlueSearchExtension());
